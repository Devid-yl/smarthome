<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SmartHome</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">    <link rel="stylesheet" href="/static/main.css">
        <style>
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>SmartHome</h1>
        <div class="navbar-right">
            <button class="btn-outline" onclick="goToInvitations()" id="invitations-btn" style="display: none;">
                Invitations <span id="invitations-count" style="background:var(--danger-color); color:white; padding:0 6px; border-radius:10px; font-size:12px; margin-left:5px;">0</span>
            </button>
            <div class="user-info" onclick="goToProfile()">
                <img id="profile-pic" src="https://via.placeholder.com/32" alt="Profile" class="profile-pic">
                <span id="username" style="font-weight:500; font-size:0.875rem; color:var(--text-main);">Utilisateur</span>
            </div>
            <button class="btn-secondary" onclick="logout()" style="color: #ef4444 !important;">Déconnexion</button>
        </div>
    </nav>

    <div class="container">
        <div class="search-section">
            <h3 style="margin-top:0; font-size:1.125rem; font-weight:600;">Rechercher une maison</h3>
            <p style="color:var(--text-muted); font-size:0.875rem; margin-bottom:1rem;">
                Trouvez une maison publique et demandez l'accès pour devenir occupant
            </p>
            <div class="search-box">
                <input type="text" id="search-house-input" class="search-input" placeholder="Nom de la maison..." onkeyup="handleSearchKeyup(event)">
                <button class="btn-outline" onclick="searchHouses()">Rechercher</button>
            </div>
            <div id="search-results" style="margin-top:1rem;"></div>
        </div>

        <div class="header-actions">
            <h2>Mes Maisons</h2>
            <button class="btn-primary" onclick="showAddHouseModal()">Ajouter une maison</button>
        </div>

        <div id="loading" style="text-align:center; padding:3rem; color:var(--text-muted);">Chargement...</div>
        <div id="houses-container" class="houses-grid" style="display: none;"></div>
        <div id="empty-state" style="text-align:center; padding:3rem; color:var(--text-muted); display:none;">
            <p>Vous n'avez pas encore de maison.</p>
        </div>
    </div>

    <div id="house-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0; font-size:1.25rem;">Ajouter une maison</h2>
            <form id="house-form">
                <div class="form-group">
                    <label for="house-name">Nom</label>
                    <input type="text" id="house-name" required>
                </div>
                <div class="form-group">
                    <label for="house-address">Adresse</label>
                    <input type="text" id="house-address" placeholder="Ex: 15 Rue de la Paix, Paris" required>
                    <div id="address-validation" class="address-validation"></div>
                </div>
                <div class="form-group">
                    <label for="house-length">Longueur (cases)</label>
                    <input type="number" id="house-length" min="1" max="50" value="10">
                </div>
                <div class="form-group">
                    <label for="house-width">Largeur (cases)</label>
                    <input type="number" id="house-width" min="1" max="50" value="10">
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn-outline" onclick="closeModal()">Annuler</button>
                    <button type="button" id="edit-inside-btn" class="btn-outline" style="display: none;" onclick="editInsideFromModal()">Éditer intérieur</button>
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let houses = [];
        let editingHouseId = null;
        let addressValidationTimeout = null;
        let isAddressValid = false;

        async function validateAddress(address) {
            const validationDiv = document.getElementById('address-validation');
            const addressInput = document.getElementById('house-address');
            
            if (!address || address.trim().length < 3) {
                validationDiv.style.display = 'none';
                isAddressValid = false;
                return;
            }
            
            validationDiv.className = 'address-validation validating';
            validationDiv.style.display = 'block';
            validationDiv.textContent = 'Vérification...';
            
            try {
                const response = await fetch(`/api/weather/validate-address`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        validationDiv.className = 'address-validation valid';
                        validationDiv.innerHTML = `Adresse valide: <strong>${data.location}</strong>`;
                        isAddressValid = true;
                    } else {
                        validationDiv.className = 'address-validation invalid';
                        validationDiv.textContent = 'Adresse non reconnue';
                        isAddressValid = false;
                    }
                } else {
                    validationDiv.className = 'address-validation invalid';
                    validationDiv.textContent = 'Impossible de valider';
                    isAddressValid = false;
                }
            } catch (error) {
                validationDiv.className = 'address-validation invalid';
                validationDiv.textContent = 'Erreur de connexion';
                isAddressValid = false;
            }
        }
        
        function setupAddressValidation() {
            const addressInput = document.getElementById('house-address');
            addressInput.addEventListener('input', (e) => {
                clearTimeout(addressValidationTimeout);
                addressValidationTimeout = setTimeout(() => {
                    validateAddress(e.target.value);
                }, 800);
            });
        }
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('username').textContent = currentUser.username;
                    if (currentUser.profile_image) {
                        document.getElementById('profile-pic').src = currentUser.profile_image;
                    }
                    loadHouses();
                } else {
                    window.location.href = '/app/login.html';
                }
            } catch (error) {
                window.location.href = '/app/login.html';
            }
        }
        
        function goToProfile() {
            window.location.href = '/app/profile.html';
        }

        async function loadHouses() {
            try {
                const response = await fetch('/api/houses');
                if (response.ok) {
                    const data = await response.json();
                    houses = data.houses;
                    displayHouses();
                    checkEditParam();
                } else {
                    alert('Erreur de chargement des maisons');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        }

        function displayHouses() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('houses-container');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'none';

            if (houses.length === 0) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'grid';
            container.innerHTML = '';

            houses.forEach(house => {
                const card = document.createElement('div');
                card.className = 'house-card';
                card.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        viewHouse(house.id);
                    }
                };
                
                let roleClass = 'role-occupant';
                let roleLabel = house.role || 'Occupant';
                if (house.is_owner) {
                    roleClass = 'role-owner';
                    roleLabel = 'Propriétaire';
                } else if (house.role === 'administrateur') {
                    roleClass = 'role-admin';
                    roleLabel = 'Admin';
                }
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:1rem;">
                        <h3 style="margin:0; font-size:1.125rem; font-weight:600;">${house.name}</h3>
                        <span class="role-badge ${roleClass}">${roleLabel}</span>
                    </div>
                    <div style="color:var(--text-muted); font-size:0.875rem;">
                        <div style="margin-bottom:0.25rem;">${house.address || 'Pas d\'adresse'}</div>
                        <div>${house.length * house.width} m²</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function showAddHouseModal() {
            editingHouseId = null;
            document.getElementById('modal-title').textContent = 'Ajouter une maison';
            document.getElementById('house-form').reset();
            document.getElementById('house-length').disabled = false;
            document.getElementById('house-width').disabled = false;
            document.getElementById('edit-inside-btn').style.display = 'none';
            document.getElementById('address-validation').style.display = 'none';
            isAddressValid = false;
            document.getElementById('house-modal').style.display = 'block';
            setupAddressValidation();
        }
        
        function checkEditParam() {
            const params = new URLSearchParams(window.location.search);
            const editId = params.get('edit');
            if (editId && houses.length > 0) {
                editHouse(parseInt(editId));
                window.history.replaceState({}, '', '/app/dashboard.html');
            }
        }

        function editHouse(id) {
            const house = houses.find(h => h.id === id);
            if (!house) return;

            editingHouseId = id;
            document.getElementById('modal-title').textContent = 'Modifier la maison';
            document.getElementById('house-name').value = house.name;
            document.getElementById('house-address').value = house.address || '';
            document.getElementById('house-length').value = house.length;
            document.getElementById('house-width').value = house.width;
            document.getElementById('house-length').disabled = true;
            document.getElementById('house-width').disabled = true;
            document.getElementById('edit-inside-btn').style.display = 'inline-block';
            
            if (house.address) {
                isAddressValid = true;
                setTimeout(() => validateAddress(house.address), 100);
            }
            
            document.getElementById('house-modal').style.display = 'block';
            setupAddressValidation();
        }

        function viewHouse(id) {
            window.location.href = `/app/house.html?id=${id}`;
        }
        
        function editInsideFromModal() {
            if (editingHouseId) {
                window.location.href = `/houses/edit_inside/${editingHouseId}`;
            }
        }

        function closeModal() {
            document.getElementById('house-modal').style.display = 'none';
        }

        document.getElementById('house-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAddressValid) {
                alert('Veuillez saisir une adresse valide.');
                return;
            }

            const data = {
                name: document.getElementById('house-name').value,
                address: document.getElementById('house-address').value,
                length: parseInt(document.getElementById('house-length').value),
                width: parseInt(document.getElementById('house-width').value)
            };

            try {
                let response;
                if (editingHouseId) {
                    response = await fetch(`/api/houses/${editingHouseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/houses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    closeModal();
                    loadHouses();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erreur lors de l\'enregistrement');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        });

        async function loadInvitations() {
            try {
                const response = await fetch('/api/invitations');
                if (response.ok) {
                    const data = await response.json();
                    const count = data.invitations.length;
                    if (count > 0) {
                        document.getElementById('invitations-btn').style.display = 'inline-flex';
                        document.getElementById('invitations-count').textContent = count;
                    }
                }
            } catch (error) {
                console.error('Erreur invitations:', error);
            }
        }

        function goToInvitations() {
            window.location.href = '/app/invitations.html';
        }

        async function searchHouses() {
            const query = document.getElementById('search-house-input').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Entrez au moins 2 caractères</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p style="text-align:center;">Recherche...</p>';
            
            try {
                const response = await fetch(`/api/houses/search?q=${encodeURIComponent(query)}`);
                if (response.ok) {
                    const data = await response.json();
                    displaySearchResults(data.houses);
                } else {
                    resultsDiv.innerHTML = '<p style="color:var(--danger-color);">Erreur lors de la recherche</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<p style="color:var(--danger-color);">Erreur de connexion</p>';
            }
        }
        
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                searchHouses();
            }
        }
        
        function displaySearchResults(houses) {
            const resultsDiv = document.getElementById('search-results');
            
            if (houses.length === 0) {
                resultsDiv.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Aucune maison trouvée</p>';
                return;
            }
            
            resultsDiv.innerHTML = houses.map(house => {
                let statusInfo = '';
                let actionButton = '';
                
                if (house.relationship_status === 'owner') {
                    statusInfo = '<span class="role-badge role-owner">Propriétaire</span>';
                } else if (house.relationship_status === 'accepted') {
                    statusInfo = '<span class="role-badge role-occupant">Membre</span>';
                } else if (house.relationship_status === 'pending') {
                    statusInfo = '<span class="role-badge" style="background:#fef3c7; color:#92400e;">En attente</span>';
                } else if (house.relationship_status === 'rejected') {
                    statusInfo = '<span class="role-badge" style="background:#fee2e2; color:#991b1b;">Refusé</span>';
                    actionButton = `<button class="btn-outline" style="font-size:0.75rem;" onclick="requestAccess(${house.id})">Redemander</button>`;
                } else {
                    actionButton = `<button class="btn-outline" style="font-size:0.75rem;" onclick="requestAccess(${house.id})">Demander accès</button>`;
                }
                
                return `
                    <div class="search-result-item">
                        <div>
                            <h4 style="margin:0 0 0.25rem 0; font-size:0.875rem;">${house.name}</h4>
                            <p style="margin:0; color:var(--text-muted); font-size:0.75rem;">Propriétaire: ${house.owner_username || 'Inconnu'}</p>
                            <div style="margin-top:0.25rem;">${statusInfo}</div>
                        </div>
                        ${actionButton}
                    </div>
                `;
            }).join('');
        }
        
        async function requestAccess(houseId) {
            const message = prompt('Message pour le propriétaire:');
            if (message === null) return;
            
            try {
                const response = await fetch(`/api/houses/${houseId}/request-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    alert('Demande envoyée !');
                    searchHouses();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erreur lors de la demande');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/app/login.html';
            } catch (error) {
                window.location.href = '/app/login.html';
            }
        }

        checkAuth();
        loadInvitations();
    </script>
</body>
</html>
