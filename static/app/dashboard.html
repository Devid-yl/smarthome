<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SmartHome</title>
    <link rel="stylesheet" href="/static/main.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .navbar {
            background: #007bff;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            font-size: 24px;
        }
        
        .navbar-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .invitations-btn {
            position: relative;
            background: #ffc107;
            color: #333;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .invitations-btn:hover {
            background: #e0a800;
        }
        
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .user-info:hover {
            opacity: 0.8;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }
        
        .btn-logout {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-primary:hover {
            background: #218838;
        }
        
        .houses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .house-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .house-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .house-card .actions {
            position: relative;
            z-index: 10;
        }
        
        .house-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .house-card p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .house-card .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-view {
            background: #007bff;
            color: white;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #333;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .address-validation {
            margin-top: 5px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .address-validation.validating {
            display: block;
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .address-validation.valid {
            display: block;
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .address-validation.invalid {
            display: block;
            background: #ffebee;
            color: #c62828;
        }
        
        input.address-valid {
            border-color: #4caf50 !important;
            background: #f1f8f4;
        }
        
        input.address-invalid {
            border-color: #f44336 !important;
            background: #fff5f5;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .rooms-list {
            margin-top: 10px;
            padding-left: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .role-proprietaire {
            background: #28a745;
            color: white;
        }
        
        .role-administrateur {
            background: #007bff;
            color: white;
        }
        
        .role-occupant {
            background: #6c757d;
            color: white;
        }
        
        .section-divider {
            margin: 40px 0 20px;
            padding: 10px 0;
            border-bottom: 2px solid #ddd;
        }
        
        .section-title {
            font-size: 20px;
            color: #333;
            font-weight: bold;
        }
        
        .search-houses-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn-search {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .search-results {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        
        .search-result-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .search-result-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .btn-request {
            background: #ffc107;
            color: #333;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-request:hover {
            background: #e0a800;
        }
        
        .btn-request:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #ffc107;
            color: #333;
        }
        
        .status-accepted {
            background: #28a745;
            color: white;
        }
        
        .status-rejected {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üè† SmartHome</h1>
        <div class="navbar-right">
            <button class="invitations-btn" onclick="goToInvitations()" id="invitations-btn" style="display: none;">
                ‚úâÔ∏è Invitations
                <span class="badge-count" id="invitations-count">0</span>
            </button>
            <div class="user-info" onclick="goToProfile()">
                <img id="profile-pic" 
                     src="https://via.placeholder.com/40?text=U" 
                     alt="Profile" 
                     class="profile-pic">
                <span id="username">Utilisateur</span>
            </div>
            <button class="btn-logout" onclick="logout()">D√©connexion</button>
        </div>
    </nav>

    <div class="container">
        <!-- Section recherche de maisons -->
        <div class="search-houses-section">
            <h3>üîç Rechercher une maison</h3>
            <p style="color: #666; margin-bottom: 15px;">
                Trouvez une maison publique et demandez l'acc√®s pour devenir occupant
            </p>
            <div class="search-box">
                <input type="text" 
                       id="search-house-input" 
                       class="search-input" 
                       placeholder="Nom de la maison..."
                       onkeyup="handleSearchKeyup(event)">
                <button class="btn-search" onclick="searchHouses()">Rechercher</button>
            </div>
            <div id="search-results" class="search-results"></div>
        </div>

        <div class="header-actions">
            <h2>Mes Maisons</h2>
            <button class="btn-primary" onclick="showAddHouseModal()">
                ‚ûï Ajouter une maison
            </button>
        </div>

        <div id="loading" class="loading">Chargement...</div>
        <div id="houses-container" class="houses-grid" style="display: none;"></div>
        <div id="empty-state" class="empty-state" style="display: none;">
            <p>Vous n'avez pas encore de maison.</p>
            <p>Cliquez sur "Ajouter une maison" pour commencer !</p>
        </div>
    </div>

    <!-- Modal Ajouter/Modifier maison -->
    <div id="house-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Ajouter une maison</h2>
            <form id="house-form">
                <div class="form-group">
                    <label for="house-name">Nom *</label>
                    <input type="text" id="house-name" required>
                </div>
                <div class="form-group">
                    <label for="house-address">Adresse *</label>
                    <input type="text" 
                           id="house-address" 
                           placeholder="Ex: Paris, 15 Rue de la Paix 75002"
                           required>
                    <div id="address-validation" class="address-validation"></div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        L'adresse doit √™tre reconnue par l'API m√©t√©o (ville, code postal...)
                    </small>
                </div>
                <div class="form-group">
                    <label for="house-length">Longueur (cases)</label>
                    <input type="number" id="house-length" min="1" max="50" value="10">
                </div>
                <div class="form-group">
                    <label for="house-width">Largeur (cases)</label>
                    <input type="number" id="house-width" min="1" max="50" value="10">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button type="submit" class="btn-primary">Enregistrer</button>
                    <button type="button" class="btn-small" onclick="closeModal()">Annuler</button>
                    <button type="button" 
                            id="edit-inside-btn" 
                            class="btn-small" 
                            style="background: #6c757d; color: white; display: none;" 
                            onclick="editInsideFromModal()">
                        üè† √âditer int√©rieur
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let houses = [];
        let editingHouseId = null;
        let addressValidationTimeout = null;
        let isAddressValid = false;

        // Valider l'adresse avec l'API m√©t√©o
        async function validateAddress(address) {
            const validationDiv = document.getElementById('address-validation');
            const addressInput = document.getElementById('house-address');
            
            if (!address || address.trim().length < 3) {
                validationDiv.style.display = 'none';
                addressInput.classList.remove('address-valid', 'address-invalid');
                isAddressValid = false;
                return;
            }
            
            // Afficher "V√©rification..."
            validationDiv.className = 'address-validation validating';
            validationDiv.textContent = 'üîç V√©rification de l\'adresse...';
            addressInput.classList.remove('address-valid', 'address-invalid');
            
            try {
                // Cr√©er une maison temporaire pour tester l'API m√©t√©o
                const testHouseId = editingHouseId || 'test';
                const response = await fetch(`/api/weather/validate-address`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        validationDiv.className = 'address-validation valid';
                        validationDiv.innerHTML = `‚úÖ Adresse valide: <strong>${data.location}</strong>`;
                        addressInput.classList.add('address-valid');
                        addressInput.classList.remove('address-invalid');
                        isAddressValid = true;
                    } else {
                        validationDiv.className = 'address-validation invalid';
                        validationDiv.textContent = '‚ùå Adresse non reconnue par l\'API m√©t√©o';
                        addressInput.classList.add('address-invalid');
                        addressInput.classList.remove('address-valid');
                        isAddressValid = false;
                    }
                } else {
                    validationDiv.className = 'address-validation invalid';
                    validationDiv.textContent = '‚ùå Impossible de valider l\'adresse';
                    addressInput.classList.add('address-invalid');
                    addressInput.classList.remove('address-valid');
                    isAddressValid = false;
                }
            } catch (error) {
                validationDiv.className = 'address-validation invalid';
                validationDiv.textContent = '‚ö†Ô∏è Erreur de connexion';
                addressInput.classList.add('address-invalid');
                addressInput.classList.remove('address-valid');
                isAddressValid = false;
            }
        }
        
        // Validation en temps r√©el avec debounce
        function setupAddressValidation() {
            const addressInput = document.getElementById('house-address');
            addressInput.addEventListener('input', (e) => {
                clearTimeout(addressValidationTimeout);
                addressValidationTimeout = setTimeout(() => {
                    validateAddress(e.target.value);
                }, 800); // Attendre 800ms apr√®s la derni√®re frappe
            });
        }
        
        // V√©rifier l'authentification au chargement
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('username').textContent = currentUser.username;
                    
                    // Afficher la photo de profil si elle existe
                    if (currentUser.profile_image) {
                        document.getElementById('profile-pic').src = currentUser.profile_image;
                    }
                    
                    loadHouses();
                } else {
                    window.location.href = '/app/login.html';
                }
            } catch (error) {
                window.location.href = '/app/login.html';
            }
        }
        
        // Aller au profil
        function goToProfile() {
            window.location.href = '/app/profile.html';
        }

        // Charger les maisons
        async function loadHouses() {
            try {
                const response = await fetch('/api/houses');
                if (response.ok) {
                    const data = await response.json();
                    houses = data.houses;
                    displayHouses();
                    checkEditParam(); // V√©rifier si on doit ouvrir le modal d'√©dition
                } else {
                    alert('Erreur de chargement des maisons');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        }

        // Afficher les maisons
        function displayHouses() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('houses-container');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'none';

            if (houses.length === 0) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'grid';
            container.innerHTML = '';

            houses.forEach(house => {
                const card = document.createElement('div');
                card.className = 'house-card';
                card.onclick = (e) => {
                    // Ne pas naviguer si on clique sur un bouton
                    if (!e.target.closest('.actions')) {
                        viewHouse(house.id);
                    }
                };
                
                let roleClass = 'role-occupant';
                let roleLabel = house.role || 'Occupant';
                if (house.is_owner) {
                    roleClass = 'role-proprietaire';
                    roleLabel = 'Propri√©taire';
                } else if (house.role === 'administrateur') {
                    roleClass = 'role-administrateur';
                    roleLabel = 'Administrateur';
                }
                
                card.innerHTML = `
                    <div class="role-badge ${roleClass}">${roleLabel}</div>
                    <h3>${house.name}</h3>
                    <p>${house.address || 'Pas d\'adresse'}</p>
                    <p><strong>Dimensions:</strong> ${house.length} √ó ${house.width}</p>
                    ${house.rooms && house.rooms.length > 0 ? `
                        <div class="rooms-list">
                            <strong>Pi√®ces:</strong>
                            <ul>
                                ${house.rooms.map(r => `<li>${r.name}</li>`).join('')}
                            </ul>
                        </div>
                    ` : '<p style="color: #999;">Aucune pi√®ce</p>'}
                `;
                container.appendChild(card);
            });
        }

        // Afficher le modal d'ajout
        function showAddHouseModal() {
            editingHouseId = null;
            document.getElementById('modal-title').textContent = 'Ajouter une maison';
            document.getElementById('house-form').reset();
            
            // R√©activer les dimensions pour une nouvelle maison
            document.getElementById('house-length').disabled = false;
            document.getElementById('house-width').disabled = false;
            
            // Cacher le bouton "√âditer int√©rieur"
            document.getElementById('edit-inside-btn').style.display = 'none';
            
            // R√©initialiser la validation
            document.getElementById('address-validation').style.display = 'none';
            document.getElementById('house-address').classList.remove('address-valid', 'address-invalid');
            isAddressValid = false;
            
            document.getElementById('house-modal').style.display = 'block';
            setupAddressValidation();
        }
        
        // V√©rifier si on doit ouvrir le modal d'√©dition au chargement
        function checkEditParam() {
            const params = new URLSearchParams(window.location.search);
            const editId = params.get('edit');
            if (editId && houses.length > 0) {
                editHouse(parseInt(editId));
                // Nettoyer l'URL
                window.history.replaceState({}, '', '/app/dashboard.html');
            }
        }

        // Modifier une maison
        function editHouse(id) {
            const house = houses.find(h => h.id === id);
            if (!house) return;

            editingHouseId = id;
            document.getElementById('modal-title').textContent = 'Modifier la maison';
            document.getElementById('house-name').value = house.name;
            document.getElementById('house-address').value = house.address || '';
            document.getElementById('house-length').value = house.length;
            document.getElementById('house-width').value = house.width;
            
            // D√©sactiver les dimensions car elles ne peuvent pas √™tre modifi√©es
            document.getElementById('house-length').disabled = true;
            document.getElementById('house-width').disabled = true;
            
            // Afficher le bouton "√âditer int√©rieur"
            document.getElementById('edit-inside-btn').style.display = 'inline-block';
            
            // Valider l'adresse existante
            if (house.address) {
                isAddressValid = true; // Consid√©rer l'adresse existante comme valide
                setTimeout(() => validateAddress(house.address), 100);
            }
            
            document.getElementById('house-modal').style.display = 'block';
            setupAddressValidation();
        }

        // Voir une maison (rediriger vers la page de d√©tails)
        function viewHouse(id) {
            window.location.href = `/app/house.html?id=${id}`;
        }
        
        // √âditer l'int√©rieur depuis le modal
        function editInsideFromModal() {
            if (editingHouseId) {
                window.location.href = `/houses/edit_inside/${editingHouseId}`;
            }
        }

        // Supprimer une maison
        async function deleteHouse(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette maison ?')) return;

            try {
                const response = await fetch(`/api/houses/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadHouses();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('house-modal').style.display = 'none';
        }

        // Soumettre le formulaire
        document.getElementById('house-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // V√©rifier que l'adresse est valide
            if (!isAddressValid) {
                alert('‚ùå Veuillez saisir une adresse valide reconnue par l\'API m√©t√©o.');
                document.getElementById('house-address').focus();
                return;
            }

            const data = {
                name: document.getElementById('house-name').value,
                address: document.getElementById('house-address').value,
                length: parseInt(document.getElementById('house-length').value),
                width: parseInt(document.getElementById('house-width').value)
            };

            try {
                let response;
                if (editingHouseId) {
                    response = await fetch(`/api/houses/${editingHouseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/houses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    closeModal();
                    loadHouses();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erreur lors de l\'enregistrement');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        });

        // Charger les invitations
        async function loadInvitations() {
            try {
                const response = await fetch('/api/invitations');
                if (response.ok) {
                    const data = await response.json();
                    const count = data.invitations.length;
                    
                    if (count > 0) {
                        document.getElementById('invitations-btn').style.display = 'block';
                        document.getElementById('invitations-count').textContent = count;
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des invitations:', error);
            }
        }

        function goToInvitations() {
            window.location.href = '/app/invitations.html';
        }

        // Rechercher des maisons
        async function searchHouses() {
            const query = document.getElementById('search-house-input').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<p style="color: #999; text-align: center;">Entrez au moins 2 caract√®res</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p style="text-align: center;">Recherche...</p>';
            
            try {
                const response = await fetch(`/api/houses/search?q=${encodeURIComponent(query)}`);
                if (response.ok) {
                    const data = await response.json();
                    displaySearchResults(data.houses);
                } else {
                    resultsDiv.innerHTML = '<p style="color: #dc3545;">Erreur lors de la recherche</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<p style="color: #dc3545;">Erreur de connexion</p>';
            }
        }
        
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                searchHouses();
            }
        }
        
        function displaySearchResults(houses) {
            const resultsDiv = document.getElementById('search-results');
            
            if (houses.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #999; text-align: center;">Aucune maison trouv√©e</p>';
                return;
            }
            
            resultsDiv.innerHTML = houses.map(house => {
                let statusInfo = '';
                let actionButton = '';
                
                if (house.relationship_status === 'owner') {
                    statusInfo = '<span class="status-badge" style="background: #28a745; color: white;">Vous √™tes propri√©taire</span>';
                } else if (house.relationship_status === 'accepted') {
                    statusInfo = '<span class="status-badge status-accepted">Membre</span>';
                } else if (house.relationship_status === 'pending') {
                    statusInfo = '<span class="status-badge status-pending">Demande en attente</span>';
                } else if (house.relationship_status === 'rejected') {
                    statusInfo = '<span class="status-badge status-rejected">Demande refus√©e</span>';
                    actionButton = `<button class="btn-request" onclick="requestAccess(${house.id})">Redemander l'acc√®s</button>`;
                } else {
                    actionButton = `<button class="btn-request" onclick="requestAccess(${house.id})">Demander l'acc√®s</button>`;
                }
                
                return `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <h4>${house.name}</h4>
                            <p>Propri√©taire: ${house.owner_username || 'Inconnu'}</p>
                            ${statusInfo}
                        </div>
                        ${actionButton}
                    </div>
                `;
            }).join('');
        }
        
        async function requestAccess(houseId) {
            const message = prompt('Message optionnel pour le propri√©taire:');
            if (message === null) return; // Annul√©
            
            try {
                const response = await fetch(`/api/houses/${houseId}/request-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    alert('Demande d\'acc√®s envoy√©e !');
                    searchHouses(); // Rafra√Æchir les r√©sultats
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erreur lors de la demande');
                }
            } catch (error) {
                alert('Erreur de connexion au serveur');
            }
        }

        // D√©connexion
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/app/login.html';
            } catch (error) {
                window.location.href = '/app/login.html';
            }
        }

        // Initialiser
        checkAuth();
        loadInvitations();
    </script>
</body>
</html>
